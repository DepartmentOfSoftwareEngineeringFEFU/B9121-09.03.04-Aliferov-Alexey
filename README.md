# ВКР — Алиферов Алексей Сергеевич

## Информация
Тема диплома: Разработка программной системы-тренажера игры на пианино с применением методов визуализации музыки и анализа звукового спектра

Автор: Алиферов Алексей Сергеевич

Группа: Б9121-09.03.04

Научный руководитель: доцент ДПИиИИ, к.т.н. Верещагина Е.А.

## Описание проекта
Данный проект представляет собой систему-тренажер для обучения игре на пианино, объединяющую визуализацию музыки в реальном времени с технологиями спектрального анализа для оценки качества исполнения.

**Основные возможности:**

- Визуализация MIDI-композиций - анимированный падающий пианоролл с клавиатурой фортепиано

- Запись аудио в реальном времени - захват звука с устройства аудио-ввода во время исполнения упражнения

- Генерация эталонного аудио - создание эталонных записей из MIDI-файлов с использованием WAV-семплов

- Анализ и оценка исполнения - сравнение записи пользователя с эталоном на основе хрома-признаков и DTW-алгоритма

- Управление упражнениями - интуитивный интерфейс для добавления, удаления и запуска MIDI-упражнений

## Компоненты проекта
- Python 3.8+
    - `tkinter` - графический интерфейс пользователя
    - `pygame` - графическая визуализация и MIDI-синтез (опциональный)
    - `mido`, `pypianoroll` - работа с MIDI-файлами
    - `sounddevice` - запись аудио с микрофона
    - `soundfile` - сохранение аудиофайлов
    - `librosa` - спектральный анализ аудио
    - `numpy`, `scipy` - математические вычисления и генерация эталонов

## Инструкция по запуску и использованию
> [!note]
> Система протестирована на версии Python 3.12.9
>
### 1. Установите Python (>=3.8, <=3.12.9) с официального сайта [python.org](https://www.python.org/downloads/).
### 2. Перейдя в директорию проекта, установите необходимые зависимости из файла `requirements.txt` (в виртуальное окружение .venv или глобально):
   ```bash
   pip install -r requirements.txt
   ```
### 3. Для запуска системы выполните команду:
```bash
python main.py
```
- При запуске приложение автоматически создаст в директориинеобходимые пустые папки, если они отсутствуют:
    - `exercises/` - для хранения MIDI-упражнений
    - `samples/` - для хранения WAV-сэмплов нот
> [!TIP]
> Репозиторий уже содержит папки `exercises/` и `samples/` с примерами упражнений и набором сэмплов нот для быстрой проверки общей работы системы. Для улучшения качества оценки под определённый инструмент требуется добавить новые сэпмлы, снятые с соответствующего инструмента.

### 4. Откроется главное меню программы, содержащее следующие разделы:
1. **Выбор устройства записи** — выпадающий список с выбором    устройства аудио-ввода из присутствующих в системе для записи  исполнения
2. **Настройки звука**
    - *Флаг включения проигрывания звука во время упражнения* — подключает встроенный MIDI-синтезатор для проигрывания нот во время выполнения упражнения. Может быть полезно при использовании виртуального музыкального инструмента через виртуальный аудио-кабель, например, используя DAW.

3. **Список упражнений** — отображает список доступных/добавленных MIDI-упражнений, которые можно выбрать для выполнения.
> [!IMPORTANT]
> Список упражнений подгружается из папки `exercises/` и обновляется    автоматически при перезапуске программы. Для добавления нового     упражнения просто поместите MIDI-файл в эту папку.

> [!WARNING]
> Программа поддерживает MIDI-упражнения с нотами **ТОЛЬКО** из     определенного диапазона <ins>***от MIN_NOTE до MAX_NOTE***</ins>,   который можно корректировать в файле `const.py`.
> Это позволяет регулировать соотношение масштаба пианоролл визаулизации и ожидаемый от игрока на пианино диапазон нот.
> Программа будет игнорировать упражнения с нотами вне этого    диапазона в директории `exercises/`, и не позволит добавить    упражнения с такими нотами через интерфейс.
4. **Управление упражнениями:**
   - **Добавить упражнение** — открывает диалог выбора MIDI-файла для добавления в список упражнений.
   - **Удалить упражнение** — удаляет выбранное упражнение из списка
   - **Запустить упражнение** — запускает выбранное упражнение с визуализацией и записью аудио.
> [!WARNING]
> Запуск упражнения будет недоступен, и кнопка запуска будет неактивна,     если для каждой ноты из определенного валидного диапазона в `const.py` не    найдены соответствующие WAV-сэмплы в папке `samples/`.

5. **Состояние сэмплов** — отображает информацию о наличии WAV-сэмплов в `samples/` для всех нот в диапазоне.
   - Если сэмплы для всех нот присутствуют, то состояние будет "Сэмплы присутствуют".
   - Если отсутствуют сэмплы для некоторых нот, то будет указано, какие именно ноты не имеют сэмплов. Опция запуска упражнения будет недоступна, пока не будут добавлены недостающие сэмплы.

### 5. После выбора устройства записи и MIDI-упражнения, и убедившись в наличии необходимых сэмплов, нажмите кнопку "Запустить упражнение".
### 6. Во время выполнения упражнения:
- Появится окно с визуализацией пианоролла, где падающие ноты будут соответствовать нотам из MIDI-файла.
- Внизу будет отображаться клавиатура пианино с подсветкой активных клавиш.
- Пользователю предлагается сыграть упражнение, нажимая клавиши на своём инструменте в соответствии с падающими нотами.
- Запись аудио будет происходить в реальном времени на выбранное устройство ввода с момента начала первой ноты упражнения и до окончания последней ноты.
> [!IMPORTANT]
> После завершения упражнения программа автоматически сохранит аудиозапись в формате WAV в папку `recorded_audio/`, а сгенерированный эталон этого упражнения будет сохранен в папку `reference_audio/`.
> Сами папки будут созданы автоматически, если их не существует.

### 7. После завершения упражнения будет выполнен анализ корректности исполнения, и в всплывающем окне будет показан результат.
> [!IMPORTANT]
> Анализ при первом запуске упражнения может занять бОльшее время, чем последующие, так как программа создаёт кэш в папке `__pycache__/` для ускорения последующих запусков.

## Инструкция по тестированию отдельных модулей
### 1. Тестирование MIDI-визуализации

```bash
python visualizer.py
```
Внесите изменения в секцию `if __name__ == "__main__"` для тестирования конкретного случая.
```python
# Тестирование модуля
if __name__ == "__main__":
    midi_file = "exercises/ёлочка.mid"  # Заменить на реальный путь к MIDI-файлу
    device_name = 'Realtek High Definition Audio (#1)'  # Заменить на нужное имя устройства
    # Если задан параметр device_name, то будет использоваться запись звука и производиться оценка исполнения
    # При enable_sound=True будет использоваться встроенный MIDI-синтезатор для проигрывания нот
    run_visualization(midi_file, enable_sound=False, device_name=device_name)
```
### 2. Тестирование генератора эталонов
```bash
python reference_generator.py
```
Внесите изменения в секцию `if __name__ == "__main__"` для тестирования конкретного случая.
```python
# Тестирование модуля
if __name__ == "__main__":
    midi_file = "exercises/ёлочка.mid"  # Заменить на реальный путь к MIDI-файлу
    output_file = "reference_audio/example_reference.wav" # Заменить на реальный путь сохраняемого аудиофайла

    success = generate_reference_audio(midi_file, output_file)

    if success:
        print("Эталонный аудиофайл успешно создан!")
    else:
        print("Ошибка при создании эталонного аудиофайла.")
```
### 3. Тестирование оценщика исполнения

```bash
python performance_evaluator.py
```
Внесите изменения в секцию `if __name__ == "__main__"` для тестирования конкретного случая.
```python
# Тестирование модуля
if __name__ == "__main__":
    evaluator = PerformanceEvaluator()
    # Пути к записи и эталону заменить на нужные
    results = evaluator.evaluate("reference_audio/example_reference.wav", "recorded_audio/example_performance.wav")

    print("DTW Distance:", results['dtw_distance'])
    print("Similarity Score:", results['similarity'])
```
